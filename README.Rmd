---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  fig.path = "man/figures/"
)
```

# insurancerating

<!-- badges: start -->
[![CRAN Status](https://www.r-pkg.org/badges/version/insurancerating)](https://cran.r-project.org/package=insurancerating)
[![Downloads](https://cranlogs.r-pkg.org/badges/insurancerating?color=blue)](https://cran.rstudio.com/package=insurancerating)
<!-- badges: end -->

The goal of `insurancerating` is to give analytic techniques that can be used in insurance rating. It provides a data driven strategy for the construction of 
tariff classes in P&C insurance. The goal is to bin the continuous factors such that categorical risk factors result which capture the effect of the covariate on the response in an accurate way, while being easy to use in a generalized linear model (GLM).

`insurancerating` also provides recipes on how to easily perform univariate analyses on an insurance portfolio. In addition it adds functionality to include reference categories in the levels of the coefficients in the output of a generalized linear regression analysis. 

## Installation

Install insurancerating from CRAN:

```{r, eval = FALSE}
install.packages("insurancerating")
```

Or the development version from GitHub:

```{r gh-installation, eval = FALSE}
# install.packages("devtools")
devtools::install_github("MHaringa/insurancerating")
```

## Example 1
This is a basic example which shows the techniques provided in insurancerating. 

The first part shows how to fit a GAM for the variable *age_policyholder* in the MTPL dataset: 

```{r example, eval = TRUE, message = FALSE, warning = FALSE}
library(insurancerating)

# Claim frequency 
age_policyholder_frequency <- fit_gam(data = MTPL, 
                                      nclaims = nclaims, 
                                      x = age_policyholder, 
                                      exposure = exposure)

# Claim severity 
age_policyholder_severity <- fit_gam(data = MTPL, 
                                     nclaims = nclaims, 
                                     x = age_policyholder, 
                                     exposure = exposure, 
                                     amount = amount, 
                                     model = "severity")
```

Create plot:

```{r plotgam, eval = TRUE}

autoplot(age_policyholder_frequency, show_observations = TRUE)

```

Determine classes for the claim frequency (the points show the ratio between the observed number of claims and exposure for each age): 

```{r figfreq, eval = TRUE}

clusters_freq <- construct_tariff_classes(age_policyholder_frequency)
clusters_sev <- construct_tariff_classes(age_policyholder_severity)

autoplot(clusters_freq, show_observations = TRUE)
```

The figure shows that younger policyholders have a higher risk profile. The fitted GAM is lower than might be expected from the observed claim frequency for policyholders of age 19. This is because there are very few young policyholders of age 19 present in the portfolio. 

Show classes for the claim severity: 

```{r figsev, eval = TRUE}

age_policyholder_severity %>%
  construct_tariff_classes() %>%
  autoplot(., show_observations = TRUE, remove_outliers = 100000)

```

The second part adds the constructed tariff classes for the variable *age_policyholder* to the dataset, and sets the base level of the factor *age_policyholder* to the level with the largest exposure. In this example for claim frequency the class for ages (39,50], which contains the largest exposure. 

```{r example2, eval = TRUE, message = FALSE, warning = FALSE}

library(dplyr)

dat <- MTPL %>%
  mutate(age_policyholder_freq_cat = clusters_freq$tariff_classes) %>%
  mutate(age_policyholder_sev_cat = clusters_sev$tariff_classes) %>%
  mutate_if(is.character, as.factor) %>%
  mutate_if(is.factor, list(~biggest_reference(., exposure)))

glimpse(dat)

```

The last part is to fit a *generalized linear model*. The function rating_factors prints the output including the reference group.

```{r example3, eval = TRUE}

model <- glm(nclaims ~ age_policyholder_freq_cat, offset = log(exposure), family = "poisson", data = dat)
rating_factors(model)

```

## Example 2
This is a basic example which shows how to easily perform an univariate analysis on a MTPL portfolio using `insurancerating`.

The first part shows how to create a frequency plot for the variable `area` in the `MTPL2` dataset: 

```{r example4, eval = TRUE}

x <- univariate_frequency(MTPL2, x = area, nclaims = nclaims, exposure = exposure)

# Print output
x

# Print plot
autoplot(x)

```

Or sort risk factor into descending order by exposure:

```{r example5, eval = TRUE}

autoplot(x, sort = TRUE, dec.mark = ".", color_bg = "mediumseagreen")

```

`univariate_average_severity()` calculates the average severity: 

```{r example6, eval = TRUE}

univariate_average_severity(MTPL2, x = area, severity = amount, 
                            nclaims = nclaims, premium = premium) %>%
  autoplot(.)

```

Similar plots can be created for the risk premium, loss ratio, average premium, and exposure, using `univariate_risk_premium()`, `univariate_loss_ratio()`, `univariate_average_premium()`, and `univariate_exposure()`, respectively.

`univariate_all()` combines these plots: 

```{r example7, eval = TRUE}

y <- univariate_all(MTPL2, x = area, severity = amount, nclaims = nclaims, exposure = exposure)

# Print output
y

```

In the above output the loss ratio is not shown because the premium is not specified as input. 

```{r example8, eval = TRUE, fig.height = 6}

autoplot(y)

```

`background` can be used to remove the bar graph, `sort` orders the levels of the risk factor into descending order by exposure.

```{r example8a, eval = TRUE, fig.height = 10}

univariate_all(MTPL2, x = area, severity = amount, nclaims = nclaims, 
               exposure = exposure, premium = premium) %>%
  autoplot(., show_plots = 1:6, background = FALSE, sort = TRUE)

```

`show_plots` can be used to specify the desired plots. The following plots are available:

1. frequency (i.e. number of claims / expsore)
2. average severity (i.e. severity / number of claims)
3. risk premium (i.e. severity / exposure)
4. loss ratio (i.e. severity / premium)
5. average premium (i.e. premium / exposure)
6. exposure

Show the exposure and claim frequency: 

```{r example9, eval = TRUE}

autoplot(y, show_plots = c(6,1), background = FALSE, sort = TRUE)

```

`sort_manual` in `autoplot()` can be used to sort the risk factor into own ordering. This makes sense when the levels of the risk factor has a natural order, or when not all levels of the risk factor are desired in the output.  

```{r example10, eval = TRUE, message = FALSE, warning = FALSE}

autoplot(y, show_plots = c(6,1), background = FALSE, sort_manual = c("3", "1", "2"))

```




